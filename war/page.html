<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>CodeWars8086</title>
    <script type="text/javascript" language="javascript" src="codewars_js/codewars_js.nocache.js"></script>
    <script type="text/javascript" language="javascript" src="asm_js_main.js"></script>
<script>

var run_nasm = null

function start()
{
    run_nasm = Module.cwrap('run_nasm', null, ['string', 'string'])
    Module['print'] = printConsole
    Module['printErr'] = printConsole

}

// called when GWT finshed loading
function gwtStart()
{
   // start with two players
    addPlayersPanel()
    addPlayersPanel()

    sel_code_w1_pA.checked = true
    triggerSrc('A', 1)
}


function addTextChild(elem, txt) {
    var dummy = document.createElement("DIV")
    dummy.innerHTML = txt
    elem.appendChild(dummy.firstChild)
}

var g_nextLetter = 'A'
var g_usedLetters = []
var g_srcButtons = []  // ids of elements that are checkboxes that select a source file to be displayer

function asciiAdd(letter, val) {
    return String.fromCharCode(letter.charCodeAt(0) + val)
}

function arrayRemove(arr, value) {
    var index = arr.indexOf(value);
    if (index > -1) {
        arr.splice(index, 1);
    }
}


function addPlayersPanel() {
    if (g_usedLetters.length >= 20)
        return; // max players

    var text = '<div id="pl_frame_pLETTER" class="toppic">\
          <div class="famtitle">\
            <input class="fam_check_box hidden mycheck" id="pLETTER_fcheck" type="checkbox" checked onchange="" >\
            <label class="fam_check mycheck_label" for="pLETTER_fcheck"></label>\
            <label id="player_name_lbl_pLETTER" class="fam_label">Player LETTER</label>\
            <img src="red_ex.png" class="pl_close_icon" onclick="triggerErasePlayer(pl_frame_pLETTER, \'LETTER\')">\
            <br>\
            <select id="wtype_pLETTER" class="sel_wtype" onchange="changedWType(\'LETTER\')">\
              <option value="SINGLE" class="opt_single">Single Warrior</option>\
              <option value="TWO_IDENTICAL">Two Identical Warriors</option>\
              <option value="TWO_DIFFERENT">Two Different Warriors</option>\
            </select>\
            <input id="sel_code_w1_pLETTER" class="hidden sc-check" onchange="triggerSrc(\'LETTER\', 1)" type="checkbox">\
            <label id="sel_code_lbl_w1_pLETTER" class="sc-btn src_sel_but" for="sel_code_w1_pLETTER" >Player_LETTER</label>\
            <br>\
            <input id="sel_code_w2_pLETTER" class="hidden sc-check" onchange="triggerSrc(\'LETTER\', 2)" type="checkbox">\
            <label id="sel_code_lbl_w2_pLETTER" class="sc-btn src_sel_but" for="sel_code_w2_pLETTER">Player_LETTER2</label>\
          </div>\
        </div>'

    addTextChild(players_contaier, text.replace(/LETTER/g, g_nextLetter))

    var letter = g_nextLetter
    g_srcButtons.push('sel_code_w1_p' + letter)
    g_srcButtons.push('sel_code_w2_p' + letter)

    j_addPlayer(letter, "Player " + letter)
    changedWType(letter)

    g_usedLetters.push(letter)
    g_nextLetter = asciiAdd(g_nextLetter, 1)


}

function changedWType(letter)
{
    var v = document.getElementById('wtype_p' + letter).value
    var elem1 = document.getElementById('sel_code_lbl_w1_p' + letter)
    var elem2 = document.getElementById('sel_code_lbl_w2_p' + letter)
    var frame = document.getElementById('pl_frame_p' + letter)

    if (v == 'SINGLE' || v == 'TWO_IDENTICAL') {
        elem2.style.visibility = 'hidden'
        elem2.style.opacity = 0.0
        elem1.style.marginTop = '7px'
        frame.style.height = '110px'
    }
    else if (v == 'TWO_DIFFERENT') {
        elem2.style.visibility = 'visible'
        elem2.style.opacity = 1
        elem1.style.marginTop = ''
        frame.style.height = ''
    }

    j_changedWType(letter, v);

}


function triggerSrc(letter, index)
{
    var except_id = 'sel_code_w' + index + '_p' + letter
    for(var ni in g_srcButtons) {
        var name = g_srcButtons[ni]
        if (name == except_id)
            continue
        document.getElementById(name).checked = false
    }

    j_srcSelectionChanged(letter, index)
}

function triggerErasePlayer(elem, letter)
{
    //elem.parentNode.removeChild(elem);
    elem.addEventListener('animationend', function() {
        elem.parentNode.removeChild(elem);
    })
    elem.classList.add('removed_anim')

    arrayRemove(g_usedLetters, letter);
    arrayRemove(g_srcButtons, 'sel_code_w1_p' + letter)
    arrayRemove(g_srcButtons, 'sel_code_w2_p' + letter)

    j_removePlayer(letter)

    if (g_usedLetters.length == 0) {
        g_nextLetter = 'A'
    }
    else
    {
        // figure out what would be the next letter
        var check = 'Z' // check from Z backwards
        while(true) {
            if (g_usedLetters.indexOf(check) > -1)
                break;
            check = asciiAdd(check, -1)
        }
        if (check != 'Z')
            g_nextLetter = asciiAdd(check, 1)
        else {  // all letters are used up, check for holes
            check = 'A'
            while(check != 'Z') {
                if (g_usedLetters.indexOf(check) == -1)
                    break;
                check = asciiAdd(check, 1)
            }
            g_nextLetter = check // upper limit on number of players should avoid this causing a problem
        }
    }
}


// Java code comes to get and clear this variable to get the stdout of the nasm run
var g_outputText = null
function printConsole(line) {
    //console.log("*** " + line)
    g_outputText += line + '\n'
}


// in case there is a long line, when returning to a new line, the text will be still scrolled to the left, fix that
function fixhscroll() {
    var s = window.getSelection()
    //console.log("--" + s.rangeCount + "  " + ((s.rangeCount > 0) ? (s.getRangeAt(0).startContainer.id + ':' + s.getRangeAt(0).startOffset) : 'X'))

    if (asm_edit.scrollLeft == 0)
        return
    sel = window.getSelection();
    if (sel.rangeCount == 0)
        return
    range = sel.getRangeAt(0);
    if (range.commonAncestorContainer.parentNode != asm_edit)
        return
    if (range.startOffset == 0 || range.startOffset == 1) {
        console.log("fixed scroll")
        asm_edit.scrollLeft = 0
    }
}

// copy of a function in CodeEditor.java
function setCaret(node, offset)
{
    var range = document.createRange();
    range.setStart(node, offset);
    range.collapse(true);
    var sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
}

// called when a warning or error line in the editor is double clicked
function asm_cursorToLine(num) {
    var lineElem = document.getElementById("mark_line_" + num)
    setCaret(lineElem, 0)
    // lineElem.scrollIntoView() not doing something good
}


</script>    
<style>
body {
    margin: 0;
    -moz-user-select: -moz-none;
    -khtml-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
     user-select: none;
    background: #ffffff;
    font-family: Verdana;
}

.sc-btn {
  display: inline-block;
  /*position: absolute;*/

  /*font-family: "Helvetica Neue", "Helvetica", sans-serif;*/

  border-radius: 0.4em;

  box-shadow: inset rgba(0, 0, 0, 0.1) 0px -0.15em 0px, inset rgba(255, 255, 255, 0.2) 0px 0.15em 0px, rgba(0, 0, 0, 0.3) 0px 0.1em 0.3em;
  text-align: center;
  cursor: pointer;
  overflow: hidden; 
  
  color: #222;
  text-shadow: rgba(127, 127, 127, 0.4) 0 1px 0;
  background-color: #ebebeb;
  background-image: linear-gradient(to bottom, white, #ebebeb);   
  
  width: 100px;
  height: 40px;
  line-height: 40px;
  margin: 7px;
  outline:none;  /* no focus outline */
  font-size:110%;
}

.sc-btn:hover {
  color: #222;
  background-image: linear-gradient(to bottom, white, #d2d2d2);
  background-color: #fdfdfd;   
}

.sc-btn:active, .sc-check:checked+.sc-btn {
    box-shadow: rgba(255, 255, 255, 0.2) 0 0.1em 0, inset rgba(0, 0, 0, 0.3) 0px 0.25em 1em; 
    color: #fff;
    background-color: #dfdfdf;
    background-image: linear-gradient(to bottom, #479ceb, #1067c1); 
}
.sc-btn:checked  {

  background-color: #dfdfdf;
  background-image: linear-gradient(to bottom, #479ceb, #1067c1); 
}
.sc-btn:disabled {
   color: #ddd;
}

.sc-btn[disabled="true"] {
    box-shadow: initial;
}
.sc-btn[disabled="true"] > .sc-span { /* comes after */
    opacity: 0.3; /* for buttons with image*/
}

input[type="range"]:disabled {
    opacity: 0.4;
}

input:disabled + .sc-btn,
input:disabled + .sc-btn:hover,
input:disabled + .sc-btn:active, 
.sc-btn[disabled="true"] {
  color:#ddd;
  background-image: linear-gradient(to bottom, white, #ebebeb);
  box-shadow: initial;
}
.sc-btn:disabled + span {
  opacity:0.6
}

/* ---------------- asm ---------------------- */

.codearea {
    font-size: 16px;
    font-family: courier;
    outline: none; /* don't show focus border */
    overflow: auto;
    border: 1px solid #000000;
    border-radius: 4px;
    display: inline-block;
    padding: 9px 8px;
    white-space: pre;  /* needed for multiple spaces */
}
.codearea:disabled {
    background-color: rgb(255,255,255);
    color: rgb(0, 0, 0);
}

.allow_select {
    -moz-user-select: text; /* user can select here, override body */
    -khtml-user-select: text;
    -webkit-user-select: text;
    -ms-user-select: text;
     user-select: text;
}

#opcodes_edit {
    width:200px;
    height:500px;
    overflow-y: hidden; /* remove scroll bar */
}
#asm_linenums {
    width: 30px;
    height: 500px;
    border: none;
    padding: 9px 3px 9px 9px;
    text-align: right;
    background: #eeeeee;
    border-right: 1px solid #cccccc;
    color: #888888;
    overflow: hidden;
    border-radius: 0;

    margin: 0 0 1px 0; /* without this the editor is off by 1 pixel in chrome. no idea */
}
#asm_edit {
    width:300px;
    height:500px;
    overflow-x: hidden;
    border:none;
}
#asm_edit_and_lines {
    border: 1px solid #000000;
    border-radius: 4px;
    display: inline-block;
    height: 518px; /* 500 + padding of 9 */
}
.edit_error {
    background-color: #ffd7d7;
}
.edit_warning {
    background-color: #fff8ab;
}
#asm_output { 
    width:600px;
    height:100px;
    white-space: normal;
    padding: 9px 0 9px 0;
}

.edit_text_error {
    background-color: rgb(255,140,140);
}

.stdout_line_w:nth-child(even) {
    background: #ffeb8b;
}
.stdout_line_w:nth-child(odd) {
    background: #ffffaf;
}

.stdout_line_e:nth-child(even) {
    background: #ffcece;
}
.stdout_line_e:nth-child(odd) {
    background: #ffbcb4;
}


.stdout_line_e, .stdout_line_w {
    padding: 0 0 0 8px;
}

/*--------------- side panel -----------------*/

#players_panel {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    background: #d3ffd3;
    width: 190px;
    border-right: 1px solid #008800;
    overflow: auto;
}

#action_panel {
  position: absolute;
  left: 200px;
  top: 0;
  bottom: 0;
  right: 0;
  overflow: auto;
}
#action_rel {
  position: relative;
}

#edit_panel {
  position: absolute;
  left: 0;
  top: 0;
  width: 630px;
  margin: 8px;
}
#memory_panel {
  position: absolute;
  left: 630px;
  top: 0;

}

#players_rel {
    position: relative;
    width: 100%;
    top: 20px;
    /*bottom: 20px;*/
}

.hidden {
    position: absolute;
    z-index: -2;
    opacity: 0;
}

@keyframes fadeIn {
    from {opacity:0;}
    to {opacity:1;}
}
@keyframes fadeOut {
    from { opacity:1;  }
    to {opacity:0; }
}



.toppic {
    margin: 10px 11px 5px 10px;
    background: #71e671;
    font-family: Verdana;
    padding: 4px;
    border-radius: 5px;
    height: 145px;
    transition: height 0.1s ease-in-out;
    animation: fadeIn 200ms;
}
.removed_anim {
    animation: fadeOut 100ms;
}

.famtitle {
    height: 26px;
    line-height: 26px;
}

.mycheck + .mycheck_label {
    background: url(check_none.png) no-repeat;
    display: inline-block;
}
.mycheck:checked + .mycheck_label {
    background-image: url(check_checked.png);
}
.mycheck:indeterminate + .mycheck_label {
    background-image: url(check_int.png);
}
.fam_check {
    width: 17px;
    height: 17px;
    margin: -4px 4px 0 2px;
    vertical-align: middle;
}
.fam_label {
    display: inline-block;
    width: calc(100% - 60px);
    max-width: calc(100% - 60px);
    overflow: hidden;
    vertical-align: bottom; /* needed becaue overflow hidden changed the baseline https://stackoverflow.com/questions/22421782/css-overflow-hidden-increases-height-of-container */
}
.sel_wtype {
    border-radius: 6px;
    font-size: 14px;
    height: 25px;
    margin: 0 0 7px 3px;
    width: calc(100% - 7px);
}
.opt_single {
    background: url(check_none.png) no-repeat;
}
.src_sel_but {
    height: 30px;
    line-height: 30px;
    font-size: 16px;
    margin: 3px 0 0 15px;
    width: calc(100% - 20px);
    transition: all 0.1s ease-in-out;
}

#addFamBtn {
    width: 34px;
    height: 34px;
    margin: 4px 7px 7px 11px;;
}
#addFamBtnIn {
    background: url(plus.png) center no-repeat;
    display: inline-block;
    width: 34px;
    height: 33px;
}
.pl_close_icon {
    float: right;
    /*border: #aa0000 solid 1px;*/
    border-radius: 6px;
    padding: 4px;
}
.pl_close_icon:hover {
    background-color: rgba(255,255,255,0.7);
}

#editor_title {
    height: 30px;
    width: 300px;
    margin: 6px 0 20px 0;
    font-size: 20px;
    border-radius: 5px;
    padding: 0 0 0 10px;
    border: 1px solid #000000;
}
#editor_boxes {
}

</style>
  </head>
  <body onload="start()">

    <div id="action_panel"><div id="action_rel">
      <div id="memory_panel">
        <label id="runWarButton" class="sc-btn" >Run!</label>
        <input id="battlesPerGroupField" type="text">

        <input id="seed" type="text">
        <br>
        <input id="showBattleCheckBox", type="checkbox"><label for="showBattleCheckBox">Show session on start</label>
        <input id="startPausedCheckBox", type="checkbox"><label for="startPausedCheckBox">Start Paused</label>
        <br>
        <!-- WarFrame -->
        <canvas id="warCanvas"></canvas>
        <div id="messagesArea"></div>
        Round: <div id="roundNumber"></div>
        <label id="btnPause" class="sc-btn">Pause</label>
        <label id="btnSingleRound" class="sc-btn">Single Round</label>
        Speed: <input type="range" min="1" max="100" value="50" class="slider" id="speedSlider">
      </div>

      <div id="edit_panel">
        <input type="text" id="editor_title"><br>
        <div id="editor_boxes">
            <div id="opcodes_edit" class="codearea allow_select" wrap="off"
                 onscroll="asm_edit.scrollTop = opcodes_edit.scrollTop; asm_linenums.scrollTop = opcodes_edit.scrollTop;"></div>
            <div id="asm_edit_and_lines">
              <div id="asm_linenums" class="codearea" wrap="off">1</div>
              <div id="asm_edit" class="codearea allow_select" wrap="off" contenteditable="true" spellcheck="false"
                   onscroll="opcodes_edit.scrollTop = asm_edit.scrollTop; asm_linenums.scrollTop = asm_edit.scrollTop;"
                   onkeydown="fixhscroll()" onkeyup="fixhscroll()"></div>
            </div>
            <br>
            <div id="asm_output" class="codearea allow_select" wrap="off" > </div>
        </div>
      </div>
    </div></div>
    <div id="players_panel">
      <div id="players_rel">
        <div id="players_contaier">

        </div>
        <label id="addFamBtn" class="sc-btn" onclick="addPlayersPanel()"><span id="addFamBtnIn"></span></label>
      </div>
    </div>

  </body>
</html>